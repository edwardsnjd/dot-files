#!/usr/bin/env bash

# Usage: git_repo_stats
#
# Print stats about every commit in a Git repository.
#
# Dependencies: bash, git, and GNU utils

set -o nounset
set -o errexit

function git_repo_stats {
  paste <(git_commits "$@") <(git_commits "$@" | cut -f1 | git_stats)
}

# List core information about all commits
function git_commits {
  git log --date=short --pretty="tformat:%h	%ad	%an" "$@"
}

# List stats for all supplied commit hashes
function git_stats {
  while read -r sha
  do
    git_commit_stats "$sha"
  done
}

# Print stats for the given commit hash
function git_commit_stats {
  git show --pretty=oneline --numstat "$@" \
    | sed '1d' \
    | grep -v '^$' \
    | sed 's/\-	/0	/g' \
    | awk -v OFS='\t' \
      '
        BEGIN { files=0; added=0; removed=0; }
        { files+=1; added+=$1; removed+=$2; }
        END { print files, added, removed; }
      '
}

git_repo_stats "$@"
