#!/usr/bin/env bash

# NAME
#   lines-of-code-children - pretty table of lines of code by child directory
# USAGE
#   lines-of-code-children [path] [path...]
# OUTPUT
#   Path               Lines Graph
#   ./                 11189 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./configuration/    4816 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./tools/            6353 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩

set -o nounset
set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local heading="$(tput smul)"
  local reset="$(tput sgr0)"

  {
    for d in "${@:-./}"; do
      printf "$d\\0"
      fd . \
        --type d \
        --max-depth 1 \
        --print0 \
        --hidden \
        --exclude '\.git' \
        "$d"
    done
  } \
    | xargs -0 lines-of-code --merge-types \
    | cut -f1,3- \
    | tr ' ' '_' \
    | column -t \
    | pie-column 3 4 5 \
    | tr '_' ' ' \
    | sed -E "1s/[^ ]+/${heading}&${reset}/g"
}

Main "$@"
