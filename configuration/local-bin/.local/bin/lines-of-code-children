#!/usr/bin/env bash

# NAME
#   lines-of-code-children - pretty table of lines of code in
#   child directories
# USAGE
#   lines-of-code-children [path]
# OUTPUT
#   Path               Lines Graph
#   ./                 11189 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./configuration/    4816 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./tools/            6353 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩

set -o nounset
set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local dir="${1:-./}"

  local heading="$(tput smul)"
  local reset="$(tput sgr0)"

  {
    printf "$dir\\0"
    fd . \
      --type d \
      --max-depth 1 \
      --print0 \
      --hidden \
      --exclude '\.git' \
      "$dir"
  } \
    | xargs -0 lines-of-code --total \
    | cut -f1,3 \
    | column -t \
    | pie-column 2 \
    | sed -E "1s/[^ ]+/${heading}&${reset}/g"
}

Main "$@"
