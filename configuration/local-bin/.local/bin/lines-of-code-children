#!/usr/bin/env bash

# NAME
#   lines-of-code-children - pretty table of lines of code in
#   child directories
# USAGE
#   lines-of-code-children [path]
# OUTPUT
#   Path               Lines Graph
#   ./                 11189 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./configuration/    4816 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./tools/            6353 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩


function Main() {
  local dir="${1:-./}"

  local heading="$(tput smul)"
  local reset="$(tput sgr0)"

  fd . \
    --type d \
    --max-depth 1 \
    --print0 "$dir" \
    --hidden \
    --exclude '\.git' \
    | xargs -0 lines-of-code --total $dir \
    | awk "
      NR==1 {
        printf(\"%-27.27s %7s Graph\n\", \$1, \$3)
      }
      NR==2 {
        total=\$3
        width=$(( $(tput cols) - 27 - 1 - 7 - 1 ))
        cmd=\"xargs pie-bar --no-color --total \" total \" --width \" width
      }
      NR>=2 {
        printf(\"%-27.27s %7d \", \$1, \$3)
        print \$3 | cmd
        close(cmd)
      }
    " \
    | sed -E "1s/[^ ]+/${heading}&${reset}/g"
}

Main "$@"
