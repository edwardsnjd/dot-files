#!/usr/bin/env bash

# NAME
#   lines-of-code-children - pretty table of lines of code in
#   child directories
# USAGE
#   lines-of-code-children [path]
# OUTPUT
#   Path               Lines Graph
#   ./                 11189 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./configuration/    4816 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./tools/            6353 ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩

set -o nounset
set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local dir="${1:-./}"

  local heading="$(tput smul)"
  local reset="$(tput sgr0)"

  {
    printf "$dir\\0"
    fd . \
      --type d \
      --max-depth 1 \
      --print0 \
      --hidden \
      --exclude '\.git' \
      "$dir"
  } \
    | xargs -0 lines-of-code --total \
    | cut -f1,3 \
    | column -t \
    | awk "
      NR==1
      NR==2 {
        total=\$2
        lhs=length(\$0)
        totalwidth=$(tput cols)
        width=totalwidth - lhs - 2
        cmd=\"xargs pie-bar --no-color --total \" total \" --width \" width
      }
      NR>=2 {
        printf(\"%-\" lhs \"s  \", \$0)
        print \$2 | cmd
        close(cmd)
      }
    " \
    | sed -E "1s/[^ ]+/${heading}&${reset}/g"
}

Main "$@"
