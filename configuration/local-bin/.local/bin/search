#!/usr/bin/env bash

# Usage: search [options] QUERY
#        search foo | search -t/--tsv
#        search foo | search -t | search -x/--extension
#
# In the first form, recursively search all files and directories for the given
# query.
#
# Options: -b, --browse = browse results (default) -B, --no-browse = just
# output results rather than browsing
#
# Each match is listed, so multiple matches on the same source line will result
# in multiple search results.
#
# By default matches are browsed in `fzf` for ease of browsing and selection,
# then any selections are printed to stdout.
#
# With the `--no-browse` (or `-B`) option then the results are all printed to
# stdout without browsing.
#
# In the second form, with `--tsv`, convert output from colon delimited to tab
# delimited
#
# In the third form, with `--extension`, add an additional column to the tsv
# for the extension.

set -o nounset
set -o errexit
set -o pipefail

Main() {
  local browse=1
  local query=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -b|--browse) browse=1 ;;
      -B|--no-browse) browse=0 ;;
      -t|--tsv) ColonToTsv "$@"; exit ;;
      -x|--extension) InsertExtensionColumn "$@"; exit ;;
      *) query="$1"
    esac

    shift
  done

  if [[ $browse -eq 1 ]]; then
    Browse "$query"
  else
    List "$query"
  fi
}

function Browse() {
  rg \
    --vimgrep \
    --color=always \
    --smart-case \
    --hidden \
    --glob "!/.git/" \
    "$query" \
  | fzf \
    --ansi \
    --multi \
    --delimiter=":" \
    --with-nth="1,4.." \
    --bind "ctrl-/:toggle-preview" \
    --preview 'highlight-text {1} {2}' \
    --preview-window "+{2}-/2"
}

function List() {
  rg \
    --vimgrep \
    --color=auto \
    --smart-case \
    --hidden \
    --glob "!/.git/" \
    "$query"
}

function ColonToTsv() {
  sed 's/\t/    /g' \
   | sed -E 's/^([^:]+):([^:]+):([^:]+):(.*)$/\1\t\2\t\3\t\4/'
}

function InsertExtensionColumn() {
  awk -v FS="\t" -v OFS="\t" '{ n=$1; sub(".*\\.", "", n); sub(".*/", "", n); print $1, n, $2, $3, $4 }'
}

Main "$@"
