#!/usr/bin/env bash

# NAME
#   pie-column - add a column containing horiz stacked bar chart
#
# USAGE
#   lines-of-code | pie-column [opts] column column...
#
# OPTIONS
#   --headers N = number of headers (default = 1)
#   --width N = total width available for table (default = terminal width)
#   columns = index of column(s) to plot
#
# DEPENDENCIES
#   tput, tr, column, awk, pie-bar
#
# OUTPUT
#   Path                Lines
#   ./configuration/    4816   ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩
#   ./tools/            6353   ▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩▩

set -o nounset
set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local totalWidth="${COLS:-$(tput cols)}"
  local headerRows=1
  local color=1
  local columns=""

  if [[ ! -t 1 ]]; then color=0; fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --headers) shift && headerRows="$1" ;;
      --width) shift && totalWidth="$1" ;;
      --no-color) color=0 ;;
      *) break ;;
    esac
    shift
  done

  columns="$@"

  tr ' ' '§' \
    | column -t \
    | awk \
      -v columns="$columns" \
      -v totalWidth="$totalWidth" \
      -v headerRows="$headerRows" \
      -v color="$color" \
      '
      function max(a,b) { if (a > b) return a; else return b; }

      BEGIN {
        split(columns, columnIndices, ",| ")
        if (color == 1) colorOption=""
        else colorOption=" --no-color"
      }

      # Widths (capture)
      {
        width = length($0)
        maxWidth = max(maxWidth, width)
      }

      # Header row(s) (print)
      NR <= headerRows

      # Data rows (capture)
      NR > headerRows {
        raw[NR] = $0

        rowTotal = 0
        for (i in columnIndices) {
          value = $columnIndices[i]
          rowTotal += max(0, value)
          colValues[NR] = colValues[NR] " " value
        }

        total += rowTotal
        maxValue = max(maxValue, rowTotal)
      }

      # End (print)
      END {
        width = totalWidth - maxWidth - 2
        cmd = "xargs pie-bar --total " maxValue " --width " width colorOption

        for (i in raw) {
          printf "%-" maxWidth "s  ", raw[i]
          print colValues[i] | cmd
          close(cmd)
        }
      }
    ' \
    | tr '§' ' '
}

Main "$@"
