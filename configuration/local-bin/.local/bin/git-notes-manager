#!/usr/bin/env bash

# NAME
#   git-notes-manager - interactively browse and manage git notes
#
# USAGE
#   git notes-manager commits SHA [--only]
#   git notes-manager commits-list SHA [--only]
#   git notes-manager paths SHA [--only]
#   git notes-manager paths-list SHA [--only]
#
# SYNOPSIS
#   SHA - SHA to show

set -o nounset
#set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local subcommand="${1:-commits}"
  shift

  case ${subcommand} in
    commits) Commits "$@" ;;
    commits-list) ListCommits "$@" ;;
    paths) Paths "$@" ;;
    paths-list) ListPaths "$@" ;;
  esac
}

function Commits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local preview="git notes show {2} 2>/dev/null | bat --plain --color=always --language=md || echo no notes"
  local display="git notes-manager paths {2}"
  local annotate="git -c core.commentString='::' notes add -e {2}"
  local all="git notes-manager commits-list $sha"
  local noted="git notes-manager commits-list $sha --only"

  local magenta=$(tput setaf 5) # see terminfo
  local normal=$(tput sgr0) # see terminfo
  local nl=$'\n'
  local header1="âˆ· Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="âˆ· Actions: ${magenta}Enter${normal} display selected, ${magenta}A-Enter${normal} annotate selected"
  local header="${header1}${nl}${header2}"

  ListCommits "$sha" "$only" \
  | fzf \
      --ansi \
      --reverse \
      --no-sort \
      --prompt "Commit> " \
      --nth "3.." \
      --with-nth "1,3.." \
      --header "$header" \
      --preview "$preview" \
      --bind "ctrl-u:reload($all)" \
      --bind "ctrl-i:reload($noted)" \
      --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
      --bind "alt-enter:execute($annotate)" \
      --bind "enter:execute($display)"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function Paths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local preview="git notes show {2} 2>/dev/null | bat --plain --color=always --language=md || echo no notes"
  local display="git show {2} | bat --plain --color=always --file-name={3..}"
  local annotate="git -c core.commentString='::' notes add -e {2}"
  local all="git notes-manager paths-list $sha"
  local noted="git notes-manager paths-list $sha --only"

  local magenta=$(tput setaf 5) # see terminfo
  local normal=$(tput sgr0) # see terminfo
  local nl=$'\n'
  local header1="âˆ· Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="âˆ· Actions: ${magenta}Enter${normal} display selected, ${magenta}A-Enter${normal} annotate selected"
  local header="${header1}${nl}${header2}"

  ListPaths "$sha" "$only" \
  | fzf \
      --ansi \
      --reverse \
      --no-sort \
      --prompt "File> " \
      --header "$header" \
      --preview "$preview" \
      --with-nth "1,3.." \
      --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
      --bind "ctrl-u:reload($all)" \
      --bind "ctrl-i:reload($noted)" \
      --bind "alt-enter:execute($annotate)" \
      --bind "enter:execute($display)"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function ListCommits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  AddIndicators "$only" \
    <(ListNoteTargets) \
    <(git log --pretty="%H %h %s" "$sha")
}

function ListPaths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  AddIndicators "$only" \
    <(ListNoteTargets) \
    <(git ls-tree -r -t --format="%(objectname) %(path)" "$sha")
}

function ListNoteTargets() {
  git notes list | cut -d ' ' -f2 | sort
}

function AddIndicators() {
  local only="$([ "${1:-}" = "--only" ] && echo 1 || echo 0)"
  shift

  awk -v onIndicator="ðŸŸ¢" -v offIndicator="âšªï¸" -v only="$only" '
    NR==FNR { seen[$1]=1; next }
    {
      if ($1 in seen) print onIndicator, $0;
      else {
        if (!only) print offIndicator, $0;
      }
    }
  ' "$@"
}

Main "$@"
