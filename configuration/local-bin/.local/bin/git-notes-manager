#!/usr/bin/env bash

# NAME
#   git-notes-manager - interactively browse and manage git notes
#
# USAGE
#   git notes-manager
#   git notes-manager refs
#   git notes-manager commits SHA [--only]
#   git notes-manager commits-list SHA [--only]
#   git notes-manager paths SHA [--only]
#   git notes-manager paths-list SHA [--only]
#   git notes-manager note SHA
#   git notes-manager object SHA PATH
#
# SYNOPSIS
#   SHA - SHA to show

set -o nounset
#set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local subcommand="${1:-refs}"
  shift

  case ${subcommand} in
    refs) Refs "$@" ;;
    commits) Commits "$@" ;;
    commits-list) ListCommits "$@" ;;
    paths) Paths "$@" ;;
    paths-list) ListPaths "$@" ;;
    note) ShowNote "$@" ;;
    edit) EditNote "$@" ;;
    object) ShowObject "$@" ;;
  esac
}

magenta=$(tput setaf 5) # see terminfo
normal=$(tput sgr0) # see terminfo
nl=$'\n'

function Refs() {
  local ref="${1:-$(git rev-parse --abbrev-ref HEAD)}"

  local header1="‚à∑ Display: ${magenta}C-/${normal} toggle preview"
  local header2="‚à∑ Actions: ${magenta}Enter${normal} explore"

  ListRefs | fzf \
    --ansi \
    --reverse \
    --no-sort \
    --prompt "Ref> " \
    --query "${ref}" \
    --header "${header1}${nl}${header2}" \
    --preview "git lg {2}" \
    --with-nth "2.." \
    --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
    --bind "enter:execute(git notes-manager commits {1})"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function Commits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local header1="‚à∑ Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="‚à∑ Actions: ${magenta}Enter${normal} explore selected, ${magenta}A-Enter${normal} edit note"

  ListCommits "$sha" "$only" | fzf \
    --ansi \
    --reverse \
    --no-sort \
    --prompt "Commit> " \
    --header "${header1}${nl}${header2}" \
    --with-nth "1,3.." \
    --preview "git notes-manager note {2}" \
    --bind "ctrl-u:change-prompt(Commits> )+reload(git notes-manager commits-list $sha)" \
    --bind "ctrl-i:change-prompt(Commits [noted]> )+reload(git notes-manager commits-list $sha --only)" \
    --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
    --bind "alt-enter:execute(git notes-manager edit {2})" \
    --bind "enter:execute(git notes-manager paths {2})"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function Paths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local header1="‚à∑ Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="‚à∑ Actions: ${magenta}Enter${normal} display selected, ${magenta}A-Enter${normal} edit note"

  ListPaths "$sha" "$only" | fzf \
    --ansi \
    --reverse \
    --no-sort \
    --prompt "File> " \
    --header "${header1}${nl}${header2}" \
    --with-nth "1,3.." \
    --preview "git notes-manager note {2}" \
    --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
    --bind "ctrl-u:change-prompt(Commits> )+reload(git notes-manager paths-list $sha)" \
    --bind "ctrl-i:change-prompt(Commits [noted]> )+reload(git notes-manager paths-list $sha --only)" \
    --bind "alt-enter:execute(git notes-manager edit {2})" \
    --bind "enter:execute(git notes-manager object {2} {3..})"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function ShowNote() {
  local sha="${1:?Missing note target sha}"

  git notes show "$sha" 2>/dev/null \
  | bat --plain --color=always --language=md \
  || echo "(no note)"
}

function ShowObject() {
  local sha="${1:?Missing object sha}"
  local path="${2:?Missing object path}"

  git show "$sha" \
  | bat --plain --color=always --file-name="$path" --pager='less -+F -~ +g'
}

function EditNote() {
  local sha="${1:?Missing note target sha}"

  git \
    -c core.commentString='::' \
    notes add \
    -e \
    "$sha"
}

function ListRefs() {
  git branch --list --all --format "%(objectname) %(refname)"
}

function ListCommits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  git log --pretty="%H %h %s" "$sha" \
  | AddIndicators "$only" <(ListNoteTargets) -
}

function ListPaths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  git ls-tree -r -t --format="%(objectname) %(path)" "$sha" \
  | AddIndicators "$only" <(ListNoteTargets) -
}

function ListNoteTargets() {
  git notes list | cut -d ' ' -f2 | sort
}

# AddIndicators :: (String?, Path, Path, ...) -> String[]
function AddIndicators() {
  local only="$([ "${1:-}" = "--only" ] && echo 1 || echo 0)"
  shift

  awk -v onIndicator="üü¢" -v offIndicator="‚ö™Ô∏è" -v only="$only" '
    NR==FNR { seen[$1]=1; next }
    {
      if ($1 in seen) print onIndicator, $0;
      else if (!only) print offIndicator, $0;
    }
  ' "$@"
}

Main "$@"
