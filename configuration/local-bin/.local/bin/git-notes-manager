#!/usr/bin/env bash

# NAME
#   git-notes-manager - interactively browse and manage git notes
#
# USAGE
#   git notes-manager commits SHA [--only]
#   git notes-manager commits-list SHA [--only]
#   git notes-manager paths SHA [--only]
#   git notes-manager paths-list SHA [--only]
#   git notes-manager note SHA
#   git notes-manager object SHA PATH
#
# SYNOPSIS
#   SHA - SHA to show

set -o nounset
#set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local subcommand="${1:-commits}"
  shift

  case ${subcommand} in
    commits) Commits "$@" ;;
    commits-list) ListCommits "$@" ;;
    paths) Paths "$@" ;;
    paths-list) ListPaths "$@" ;;
    note) ShowNote "$@" ;;
    edit) EditNote "$@" ;;
    object) ShowObject "$@" ;;
  esac
}

magenta=$(tput setaf 5) # see terminfo
normal=$(tput sgr0) # see terminfo
nl=$'\n'

function Commits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local header1="âˆ· Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="âˆ· Actions: ${magenta}Enter${normal} explore, ${magenta}A-Enter${normal} edit note"
  local header="${header1}${nl}${header2}"

  ListCommits "$sha" "$only" | fzf \
    --ansi \
    --reverse \
    --no-sort \
    --prompt "Commit> " \
    --header "$header" \
    --nth "3.." \
    --with-nth "1,3.." \
    --preview "git notes-manager note {2}" \
    --bind "ctrl-u:reload(git notes-manager commits-list $sha)" \
    --bind "ctrl-i:reload(git notes-manager commits-list $sha --only)" \
    --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
    --bind "alt-enter:execute(git notes-manager edit {2})" \
    --bind "enter:execute(git notes-manager paths {2})"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function Paths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  local header1="âˆ· Display: ${magenta}C-/${normal} toggle preview, ${magenta}C-U${normal} all, ${magenta}C-I${normal} only noted"
  local header2="âˆ· Actions: ${magenta}Enter${normal} display, ${magenta}A-Enter${normal} edit note"
  local header="${header1}${nl}${header2}"

  ListPaths "$sha" "$only" | fzf \
    --ansi \
    --reverse \
    --no-sort \
    --prompt "File> " \
    --header "$header" \
    --with-nth "1,3.." \
    --preview "git notes-manager note {2}" \
    --bind "ctrl-/:change-preview-window(bottom|hidden|default)" \
    --bind "ctrl-u:reload(git notes-manager paths-list $sha)" \
    --bind "ctrl-i:reload(git notes-manager paths-list $sha --only)" \
    --bind "alt-enter:execute(git notes-manager edit {2})" \
    --bind "enter:execute(git notes-manager path {2} {3..})"

  # Force happy exit code (expect to quit fzf with Ctrl-C)
  return 0
}

function ShowNote() {
  local sha="${1:?Missing note target sha}"

  git notes show "$sha" 2>/dev/null \
  | bat --plain --color=always --language=md \
  || echo "(no note)"
}

function ShowObject() {
  local sha="${1:?Missing object sha}"
  local path="${2:?Missing object path}"

  git show "$sha" \
  | bat --plain --color=always --file-name="$path"
}

function EditNote() {
  local sha="${1:?Missing note target sha}"

  git \
    -c core.commentString='::' \
    notes add \
    -e \
    "$sha"
}

function ListCommits() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  AddIndicators "$only" \
    <(ListNoteTargets) \
    <(git log --pretty="%H %h %s" "$sha")
}

function ListPaths() {
  local sha="${1:-HEAD}"
  local only="${2:-}"

  AddIndicators "$only" \
    <(ListNoteTargets) \
    <(git ls-tree -r -t --format="%(objectname) %(path)" "$sha")
}

function ListNoteTargets() {
  git notes list | cut -d ' ' -f2 | sort
}

function AddIndicators() {
  local only="$([ "${1:-}" = "--only" ] && echo 1 || echo 0)"
  shift

  awk -v onIndicator="ðŸŸ¢" -v offIndicator="âšªï¸" -v only="$only" '
    NR==FNR { seen[$1]=1; next }
    {
      if ($1 in seen) print onIndicator, $0;
      else {
        if (!only) print offIndicator, $0;
      }
    }
  ' "$@"
}

Main "$@"
