#!/usr/bin/env bash

# NAME
#    tokei-json - code analysis using `tokei` but simplified and in JSON
#
# SYNOPSIS
#    tokei-json [--format format] [--help] [-- [tokei arguments]]
#
# OPTIONS
#    --format <format>, -f <format>
#      Print this usage info.
#    --help, -h
#      Print this usage info.
#
# DEPENDENCIES
#   - tokei
#   - sed
#   - jq

set -o nounset
set -o errexit
set -o pipefail
#set -o xtrace

function Main() {
  local format="json"
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help | -h)   Usage "$@"; exit 0 ;;
      --format | -f) shift && format=$1 ;;
      --)            shift && break ;;
      *)             Error "Unknown argument: $1" ;;
    esac
    shift
  done

  case "$format" in
    json) SummaryJson "$@" ;;
    *)    Error "Unknown format: $format" ;;
  esac
}

function Error() {
  echo "ERROR: $@" >&2
  echo >&2
  Usage >&2
  exit 1
}

function Usage() {
  sed -E -f <(GetSection "UsageSedScript") $0
}

# Get a delimited section of this file
function GetSection() {
  local section="$1"
  sed -En "/^#.*${section}:Start/,/^#.*${section}:End/ { s/^# ?//; p; }" $0 \
    | sed '1d; $d'
}

function SummaryJson() {
  tokei --files --output="json" "$@" \
    | jq -f <(GetSection "JqSummaryScript")
}

Main "$@"

exit 0

# The rest of this file is not executed, so can hold scripts for
# different languages etc.  Use `GetSection xxx` to obtain the
# text for a particular section.

#~~~~~~~~~~~~~~~~~~~~~~~~~~~ UsageSedScript:Start ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# #n
# /^#!/ n
# /^#/ {
#   :heading
#   /^#/ {
#     s/^# ?//
#     p
#     n
#     b heading
#   }
#   q
# }
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~ UsageSedScript:End ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~ JqSummaryScript:Start ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# def total_lines: (.code + .comments + .blanks);
#
# .Total | {
#   total: total_lines,
#   lines: .children | map_values(map(.stats | total_lines) | add),
#   files: .children | map_values(length),
#   details: .children | map_values(
#     sort_by(.name)
#       | map({key: (.name), value: .stats | total_lines})
#       | from_entries
#   ),
# }
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~ JqSummaryScript:End ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
