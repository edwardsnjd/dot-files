#!/usr/bin/env bash

# Interactive FZF browser of all previous words in this tmux pane
function tmux-word {
  tmux capture-pane -p -S - -E - \
    | tr " " "\n" \
    | tac \
    | dedup \
    | fzf --no-sort --query "${1:-}"
}

# Interactive FZF browser of all previous lines in this tmux pane
function tmux-line {
  tmux capture-pane -p -S - -E - \
    | tac \
    | dedup \
    | fzf --no-sort --query "!Â» ${1:-}"
}

# Complete the word at current location in the readline.
# Usage: readline-complete <cmd>
# <cmd> is the name of command to use to pick a completion.
# <cmd> will be called with the current word prefix as the only parameter.
function readline-complete() {
  local fn="$1"

  # Read the line
  local linePrefix="${READLINE_LINE:0:$READLINE_POINT}"
  local lineSuffix="${READLINE_LINE:$READLINE_POINT}"

  # Find the completion
  local currentWord="${linePrefix##* }"
  local result="$($fn "$currentWord")"

  # Nothing to do if nothing selected
  if [[ -z "$result" ]]; then return; fi

  # Adjust complete to complete the current word
  local resultSuffix="${result}"
  local resultPrefix="${result:0:${#currentWord}}"
  if [[ "$resultPrefix" = "$currentWord" ]]; then
    resultSuffix="${resultSuffix:${#currentWord}}"
  else
    linePrefix="${linePrefix:0:-${#currentWord}}"
  fi

  # Update the line
  READLINE_LINE="${linePrefix}${resultSuffix}${lineSuffix}"
  READLINE_POINT=$(( ${#linePrefix} + ${#resultSuffix} ))
}

# CTRL-x CTRL-k - Complete/replace the current word with dictionary words
bind -m emacs-standard -x '"\C-x\C-k": readline-complete words'
bind -m vi-command -x '"\C-x\C-k": readline-complete words'
bind -m vi-insert -x '"\C-x\C-k": readline-complete words'

# CTRL-x CTRL-l - Complete/replace the current word with previous lines
bind -m emacs-standard -x '"\C-x\C-l": readline-complete tmux-line'
bind -m vi-command -x '"\C-x\C-l": readline-complete tmux-line'
bind -m vi-insert -x '"\C-x\C-l": readline-complete tmux-line'

# CTRL-x CTRL-p - Complete/replace the current word with previous words
bind -m emacs-standard -x '"\C-x\C-p": readline-complete tmux-word'
bind -m vi-command -x '"\C-x\C-p": readline-complete tmux-word'
bind -m vi-insert -x '"\C-x\C-p": readline-complete tmux-word'

# CTRL-j - List current directory
bind -m emacs-standard -x '"\C-j": clear && pwd && l'
